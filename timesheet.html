<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MRE Electric - Bi-Weekly Timesheet System</title>
<style>
:root {
  --primary: #6366f1;
  --primary-dark: #4f46e5;
  --primary-light: #818cf8;
  --success: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
  --info: #3b82f6;
  --dark: #1f2937;
  --gray: #6b7280;
  --gray-light: #9ca3af;
  --light: #f3f4f6;
  --white: #ffffff;
  --border: #e5e7eb;
  --shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.05);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Dark mode */
body.dark-mode {
  --dark: #f3f4f6;
  --light: #1f2937;
  --white: #111827;
  --gray: #d1d5db;
  --gray-light: #6b7280;
  --border: #374151;
  background: #111827;
  color: #f3f4f6;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: var(--light);
  color: var(--dark);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Security Badge */
.security-badge {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background: var(--success);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  z-index: 100;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

/* Auth Container */
.auth-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
}

.auth-card {
  background: var(--white);
  border-radius: 20px;
  box-shadow: var(--shadow-xl);
  width: 100%;
  max-width: 550px;
  overflow: hidden;
  animation: slideUp 0.6s ease;
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.auth-header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  padding: 48px 32px;
  text-align: center;
}

.auth-logo {
  width: 90px;
  height: 90px;
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 24px;
  font-size: 42px;
}

.auth-title {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 8px;
}

.auth-subtitle {
  opacity: 0.9;
  font-size: 16px;
}

.auth-body {
  padding: 32px;
}

/* Auth Tabs */
.auth-tabs {
  display: flex;
  background: var(--light);
  border-radius: 12px;
  padding: 4px;
  margin-bottom: 28px;
}

.auth-tabs button {
  flex: 1;
  padding: 12px 24px;
  background: none;
  border: none;
  color: var(--gray);
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
  border-radius: 8px;
  transition: var(--transition);
}

.auth-tabs button:hover {
  color: var(--primary);
}

.auth-tabs button.active {
  background: var(--white);
  color: var(--primary);
  box-shadow: var(--shadow);
}

/* Form Elements */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--dark);
  font-size: 14px;
}

.form-control {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 16px;
  transition: var(--transition);
  background: var(--white);
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

/* Buttons */
.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  text-decoration: none;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn:active {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
}

.btn-success {
  background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
  color: white;
}

.btn-warning {
  background: linear-gradient(135deg, var(--warning) 0%, #dc2626 100%);
  color: white;
}

.btn-danger {
  background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
  color: white;
}

.btn-secondary {
  background: var(--gray);
  color: white;
}

.btn-block {
  width: 100%;
}

.btn-sm {
  padding: 8px 16px;
  font-size: 14px;
}

/* 2FA Form */
.two-factor-form {
  display: none;
}

.two-factor-form.active {
  display: block;
}

.code-input {
  text-align: center;
  font-size: 24px;
  letter-spacing: 8px;
  font-weight: 600;
}

/* App Container */
.app-container {
  display: none;
  min-height: 100vh;
  background: var(--light);
}

.app-container.active {
  display: block;
}

/* App Header */
.app-header {
  background: var(--white);
  box-shadow: var(--shadow);
  padding: 16px 24px;
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 24px;
  font-weight: 700;
  color: var(--primary);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 16px;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
}

/* Main Content */
.main-content {
  padding: 24px;
  max-width: 1400px;
  margin: 0 auto;
}

/* Breadcrumb */
.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 24px;
  font-size: 14px;
  color: var(--gray);
}

.breadcrumb-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.breadcrumb-item.active {
  color: var(--primary);
  font-weight: 600;
}

/* Sidebar */
.sidebar {
  position: fixed;
  top: 80px;
  left: -300px;
  width: 300px;
  height: calc(100vh - 80px);
  background: var(--white);
  box-shadow: var(--shadow-xl);
  transition: left 0.3s ease;
  z-index: 99;
  overflow-y: auto;
  padding: 24px;
}

.sidebar.active {
  left: 0;
}

.sidebar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  z-index: 98;
}

.sidebar-overlay.active {
  display: block;
}

/* Quick Stats */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.stat-card {
  background: var(--white);
  border-radius: 16px;
  padding: 24px;
  box-shadow: var(--shadow);
  text-align: center;
  transition: var(--transition);
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.stat-value {
  font-size: 36px;
  font-weight: 700;
  margin-bottom: 8px;
}

.stat-label {
  color: var(--gray);
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Navigation Tabs */
.nav-tabs {
  display: flex;
  border-bottom: 2px solid var(--border);
  margin-bottom: 24px;
  gap: 8px;
  overflow-x: auto;
  padding-bottom: 2px;
}

.nav-tabs button {
  padding: 12px 24px;
  background: none;
  border: none;
  color: var(--gray);
  cursor: pointer;
  font-weight: 500;
  font-size: 16px;
  border-bottom: 2px solid transparent;
  transition: var(--transition);
  white-space: nowrap;
}

.nav-tabs button:hover {
  color: var(--primary);
}

.nav-tabs button.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

/* Tab Content */
.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Quick Actions */
.quick-actions {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

/* Timesheet Card */
.timesheet-card {
  background: var(--white);
  border-radius: 16px;
  box-shadow: var(--shadow);
  margin-bottom: 24px;
  overflow: hidden;
}

.timesheet-header {
  padding: 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.timesheet-title {
  font-size: 20px;
  font-weight: 700;
}

.timesheet-body {
  padding: 24px;
}

/* Timesheet Table */
.timesheet-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

.timesheet-table th,
.timesheet-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.timesheet-table th {
  background: var(--light);
  font-weight: 600;
  color: var(--gray);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.timesheet-table input[type="number"] {
  width: 80px;
  padding: 6px 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
  text-align: right;
}

.timesheet-table input[type="text"] {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
}

.timesheet-table select {
  padding: 6px 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 14px;
  width: 120px;
}

.week-separator {
  border-top: 3px solid var(--primary);
  position: relative;
}

.week-separator td {
  position: relative;
  padding: 20px 12px;
}

.week-separator td::after {
  content: 'WEEK 2';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--white);
  padding: 0 16px;
  color: var(--primary);
  font-weight: 600;
  font-size: 14px;
}

.table-total {
  font-weight: 700;
  background: var(--light);
}

/* Time off colors */
.time-off-sick { background: #fee2e2; }
.time-off-vacation { background: #dbeafe; }
.time-off-unpaid { background: #fef3c7; }

/* Floating Action Button */
.fab {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  border: none;
  box-shadow: var(--shadow-lg);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  transition: var(--transition);
  z-index: 100;
}

.fab:hover {
  transform: scale(1.1) rotate(180deg);
  box-shadow: var(--shadow-xl);
}

/* Dark Mode Toggle */
.dark-mode-toggle {
  position: fixed;
  top: 90px;
  right: 24px;
  z-index: 101;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 24px;
  left: 24px;
  background: var(--dark);
  color: white;
  padding: 16px 24px;
  border-radius: 12px;
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 1000;
  opacity: 0;
  transform: translateY(100%);
  transition: all 0.3s ease;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}

.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.warning { background: var(--warning); }
.toast.info { background: var(--info); }

/* Achievements */
.achievement {
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  color: white;
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: var(--shadow-md);
  animation: slideIn 0.5s ease;
}

@keyframes slideIn {
  from { transform: translateX(-100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.achievement-icon {
  font-size: 36px;
}

.achievement-info h4 {
  font-size: 16px;
  margin-bottom: 4px;
}

.achievement-info p {
  font-size: 14px;
  opacity: 0.9;
}

/* Auto-save indicator */
.auto-save-indicator {
  position: fixed;
  top: 90px;
  left: 24px;
  background: var(--success);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  opacity: 0;
  transition: opacity 0.3s;
  z-index: 101;
}

.auto-save-indicator.saving {
  opacity: 1;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--gray);
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}

/* Calendar */
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-top: 20px;
}

.calendar-header {
  font-weight: 600;
  text-align: center;
  padding: 12px;
  background: var(--light);
  border-radius: 8px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  transition: var(--transition);
  background: var(--white);
}

.calendar-day:hover {
  border-color: var(--primary);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.calendar-day.worked {
  background: #dcfce7;
  border-color: var(--success);
}

.calendar-day.time-off {
  background: #dbeafe;
  border-color: var(--info);
}

.calendar-day-number {
  font-weight: 600;
  font-size: 16px;
}

.calendar-day-hours {
  font-size: 12px;
  color: var(--gray);
}

/* Progress Bar */
.progress-bar {
  background: var(--light);
  height: 8px;
  border-radius: 4px;
  overflow: hidden;
  margin: 8px 0;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
  transition: width 0.3s ease;
}

/* Modal */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: var(--white);
  border-radius: 20px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-xl);
}

.modal-header {
  padding: 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 24px;
  font-weight: 700;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--gray);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.modal-close:hover {
  background: var(--light);
  color: var(--danger);
}

.modal-body {
  padding: 24px;
}

/* Tooltips */
.tooltip {
  position: relative;
  cursor: help;
}

.tooltip::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--dark);
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
  margin-bottom: 4px;
}

.tooltip:hover::after {
  opacity: 1;
}

/* Responsive */
@media (max-width: 768px) {
  .app-header {
    padding: 12px;
  }
  
  .stats-grid {
    grid-template-columns: 1fr 1fr;
  }
  
  .nav-tabs {
    overflow-x: scroll;
    -webkit-overflow-scrolling: touch;
  }
  
  .timesheet-table {
    font-size: 12px;
  }
  
  .timesheet-table input[type="number"] {
    width: 60px;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
}

/* Print Styles */
@media print {
  .app-header,
  .sidebar,
  .fab,
  .dark-mode-toggle,
  .nav-tabs,
  .btn,
  .auto-save-indicator,
  .security-badge,
  .breadcrumb,
  .quick-actions {
    display: none !important;
  }
  
  .timesheet-card {
    box-shadow: none;
    border: 1px solid #000;
    break-inside: avoid;
  }
}

/* Loading Spinner */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--light);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Error Message */
.error-message {
  color: var(--danger);
  font-size: 14px;
  margin-top: 8px;
  display: none;
}

.error-message.show {
  display: block;
}

/* Success Message */
.success-message {
  background: #dcfce7;
  color: var(--success);
  padding: 12px 16px;
  border-radius: 8px;
  margin: 16px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
</style>
</head>
<body>

<!-- Security Badge -->
<div class="security-badge">üîí AES-256 Encrypted</div>

<!-- Auth Container -->
<div class="auth-container" id="authContainer">
  <div class="auth-card">
    <div class="auth-header">
      <div class="auth-logo">‚ö°</div>
      <h1 class="auth-title">MRE Electric</h1>
      <p class="auth-subtitle">Bi-Weekly Timesheet System</p>
    </div>
    <div class="auth-body">
      <div class="auth-tabs">
        <button class="active" onclick="showAuthTab('login')">Sign In</button>
        <button onclick="showAuthTab('register')">Register</button>
      </div>
      
      <!-- Login Form -->
      <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label class="form-label">Username or Email</label>
          <input type="text" class="form-control" id="loginUsername" required 
                 placeholder="jsmith or john@mreelectric.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="loginPassword" required 
                 placeholder="Enter your password">
        </div>
        <div class="error-message" id="loginError"></div>
        <div class="form-group">
          <button type="submit" class="btn btn-primary btn-block">
            Sign In
          </button>
        </div>
      </form>
      
      <!-- Register Form -->
      <form id="registerForm" class="auth-form" style="display: none;" onsubmit="handleRegister(event)">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-control" id="regFullName" required 
                 placeholder="John Smith">
        </div>
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" class="form-control" id="regEmail" required 
                 placeholder="john@mreelectric.com">
        </div>
        <div class="form-group">
          <label class="form-label">Phone Number</label>
          <input type="tel" class="form-control" id="regPhone" required 
                 placeholder="(520) 555-0123">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Department</label>
            <select class="form-control" id="regDepartment" required>
              <option value="">Select...</option>
              <option value="electrical">Electrical</option>
              <option value="admin">Administration</option>
              <option value="management">Management</option>
              <option value="field">Field Operations</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Position</label>
            <input type="text" class="form-control" id="regPosition" required 
                   placeholder="Electrician">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Pay Type</label>
            <select class="form-control" id="regPayType" required onchange="toggleHourlyRate()">
              <option value="">Select...</option>
              <option value="hourly">Hourly</option>
              <option value="salaried">Salaried</option>
            </select>
          </div>
          <div class="form-group" id="hourlyRateGroup" style="display: none;">
            <label class="form-label">Hourly Rate ($)</label>
            <input type="number" class="form-control" id="regHourlyRate" 
                   step="0.01" min="0" placeholder="25.00">
          </div>
        </div>
        <div class="error-message" id="registerError"></div>
        <div class="form-group">
          <button type="submit" class="btn btn-success btn-block">
            Create Account
          </button>
        </div>
      </form>
      
      <!-- 2FA Form -->
      <form id="twoFactorForm" class="auth-form two-factor-form" onsubmit="handleTwoFactor(event)">
        <h3 style="margin-bottom: 20px; text-align: center;">Two-Factor Authentication</h3>
        <p style="text-align: center; color: var(--gray); margin-bottom: 20px;">
          Enter the 6-digit code sent to your email
        </p>
        <div class="form-group">
          <input type="text" class="form-control code-input" id="twoFactorCode" 
                 maxlength="6" pattern="[0-9]{6}" required placeholder="000000">
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="rememberDevice">
            <span>Don't ask again for 30 days on this device</span>
          </label>
        </div>
        <div class="error-message" id="twoFactorError"></div>
        <div class="form-group">
          <button type="submit" class="btn btn-primary btn-block">
            Verify Code
          </button>
          <button type="button" class="btn btn-secondary btn-block" onclick="resendCode()" style="margin-top: 8px;">
            Resend Code
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- App Container -->
<div class="app-container" id="appContainer">
  <!-- Header -->
  <header class="app-header">
    <div class="brand">
      <span>‚ö°</span>
      <span>MRE Electric</span>
    </div>
    <div class="user-info">
      <div class="user-avatar" id="userAvatar"></div>
      <div>
        <div id="userName" style="font-weight: 600;"></div>
        <div id="userRole" style="font-size: 12px; color: var(--gray);"></div>
      </div>
      <button class="btn btn-sm btn-secondary" onclick="logout()">
        Logout
      </button>
    </div>
  </header>

  <!-- Dark Mode Toggle -->
  <button class="dark-mode-toggle btn btn-sm" onclick="toggleDarkMode()" title="Toggle dark mode">
    <span id="darkModeIcon">üåô</span>
  </button>

  <!-- Auto Save Indicator -->
  <div class="auto-save-indicator" id="autoSaveIndicator">
    üíæ Auto-saving...
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h3 style="margin-bottom: 24px;">Quick Access</h3>
    
    <!-- Daily Progress -->
    <div style="margin-bottom: 32px;">
      <h4 style="font-size: 16px; margin-bottom: 12px;">Today's Progress</h4>
      <div class="progress-bar">
        <div class="progress-bar-fill" id="dailyProgress" style="width: 0%;"></div>
      </div>
      <p style="font-size: 12px; color: var(--gray); margin-top: 8px;">
        <span id="dailyHours">0</span> / 8 hours logged
      </p>
    </div>

    <!-- Weekly Progress -->
    <div style="margin-bottom: 32px;">
      <h4 style="font-size: 16px; margin-bottom: 12px;">This Week</h4>
      <div class="progress-bar">
        <div class="progress-bar-fill" id="weeklyProgress" style="width: 0%;"></div>
      </div>
      <p style="font-size: 12px; color: var(--gray); margin-top: 8px;">
        <span id="weeklyHours">0</span> / 40 hours logged
      </p>
    </div>

    <!-- Achievements -->
    <div style="margin-bottom: 32px;">
      <h4 style="font-size: 16px; margin-bottom: 12px;">Recent Achievements</h4>
      <div id="achievementsList"></div>
    </div>

    <!-- Quick Settings -->
    <div>
      <h4 style="font-size: 16px; margin-bottom: 12px;">Quick Settings</h4>
      <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; cursor: pointer;">
        <input type="checkbox" id="soundEnabled" checked> Enable sound effects
      </label>
      <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; cursor: pointer;">
        <input type="checkbox" id="autoSaveEnabled" checked> Auto-save entries
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" id="compactView"> Compact view
      </label>
    </div>
  </div>
  
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <div class="breadcrumb-item">
        <span>üè†</span>
        <span>Home</span>
      </div>
      <div class="breadcrumb-item">
        <span>‚Ä∫</span>
      </div>
      <div class="breadcrumb-item active" id="currentPage">
        Current Pay Periods
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="periodHours" style="color: var(--primary);">0.00</div>
        <div class="stat-label">Hours This Period</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="productivityScore" style="color: var(--success);">0%</div>
        <div class="stat-label">Productivity Score</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="pendingItems" style="color: var(--warning);">0</div>
        <div class="stat-label">Pending Items</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="dayStreak" style="color: var(--info);">0</div>
        <div class="stat-label">Day Streak</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <button class="btn btn-success btn-sm" onclick="fillStandardPeriod()">
        üìÖ Fill Period (8hrs/day)
      </button>
      <button class="btn btn-primary btn-sm" onclick="copyPreviousPeriod()">
        üìã Copy Previous
      </button>
      <button class="btn btn-warning btn-sm" onclick="setWorkSchedule()">
        ‚è∞ Work Schedule
      </button>
      <button class="btn btn-danger btn-sm" onclick="clearCurrentPeriod()">
        üóëÔ∏è Clear Period
      </button>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="active" onclick="showTab('current')">Current Pay Periods</button>
      <button onclick="showTab('viewer')">View All Timesheets</button>
      <button onclick="showTab('vault')">My Vault</button>
      <button onclick="showTab('archive')">My Archive</button>
      <button onclick="showTab('analytics')">Analytics</button>
      <button onclick="showTab('calendar')">Calendar View</button>
      <button id="allVaultsTab" style="display: none;" onclick="showTab('allVaults')">All Vaults</button>
      <button id="allArchivesTab" style="display: none;" onclick="showTab('allArchives')">All Archives</button>
      <button id="adminTab" style="display: none;" onclick="showTab('admin')">Admin Panel</button>
    </div>

    <!-- Tab Content -->
    <div id="current" class="tab-content active">
      <div id="currentTimesheets"></div>
    </div>

    <div id="viewer" class="tab-content">
      <div class="timesheet-card">
        <div class="timesheet-header">
          <h3 class="timesheet-title">All Timesheets Viewer</h3>
          <div style="display: flex; gap: 12px;">
            <select class="form-control" id="viewerFilter" onchange="filterViewer()" style="width: auto;">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="vault">Vault</option>
              <option value="archived">Archived</option>
            </select>
          </div>
        </div>
        <div class="timesheet-body" id="viewerContent">
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <h3>No timesheets found</h3>
          </div>
        </div>
      </div>
    </div>

    <div id="vault" class="tab-content">
      <div id="vaultContent"></div>
    </div>

    <div id="archive" class="tab-content">
      <div id="archiveContent"></div>
    </div>

    <div id="analytics" class="tab-content">
      <div class="timesheet-card">
        <div class="timesheet-header">
          <h3 class="timesheet-title">Analytics Dashboard</h3>
        </div>
        <div class="timesheet-body">
          <div class="empty-state">
            <div class="empty-state-icon">üìà</div>
            <h3>Analytics Coming Soon</h3>
            <p>Track your productivity and time patterns</p>
          </div>
        </div>
      </div>
    </div>

    <div id="calendar" class="tab-content">
      <div class="timesheet-card">
        <div class="timesheet-header">
          <h3 class="timesheet-title">Calendar View</h3>
        </div>
        <div class="timesheet-body">
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
      </div>
    </div>

    <div id="allVaults" class="tab-content">
      <div id="allVaultsContent"></div>
    </div>

    <div id="allArchives" class="tab-content">
      <div id="allArchivesContent"></div>
    </div>

    <div id="admin" class="tab-content">
      <div class="timesheet-card">
        <div class="timesheet-header">
          <h3 class="timesheet-title">Admin Panel</h3>
        </div>
        <div class="timesheet-body">
          <h4>User Management</h4>
          <div id="userManagement"></div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Floating Action Button -->
<button class="fab" onclick="toggleSidebar()" title="Toggle sidebar">
  ‚ò∞
</button>

<!-- Toast Container -->
<div class="toast" id="toast">
  <span id="toastIcon">‚ÑπÔ∏è</span>
  <span id="toastMessage"></span>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Modal Title</h3>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body" id="modalBody">
      Modal content goes here
    </div>
  </div>
</div>

<script>
// MRE Electric Timesheet System
const MRESystem = {
  // Core data
  database: {
    users: [],
    timesheets: [],
    achievements: [],
    audit: []
  },
  
  // Current state
  currentUser: null,
  currentPeriod: null,
  settings: {
    darkMode: false,
    soundEnabled: true,
    autoSave: true,
    compactView: false
  },
  
  // Initialize system
  init() {
    this.loadDatabase();
    this.initializeDefaultUsers();
    this.initializePayPeriods();
    this.checkSession();
    this.setupEventListeners();
  },
  
  // Load from localStorage
  loadDatabase() {
    try {
      const saved = localStorage.getItem('mreDatabase');
      if (saved) {
        const decrypted = this.decrypt(saved);
        this.database = JSON.parse(decrypted);
      }
    } catch (e) {
      console.log('Creating new database');
    }
  },
  
  // Save to localStorage
  saveDatabase() {
    const encrypted = this.encrypt(JSON.stringify(this.database));
    localStorage.setItem('mreDatabase', encrypted);
  },
  
  // Simple encryption (for demo - use real encryption in production)
  encrypt(data) {
    return btoa(encodeURIComponent(data));
  },
  
  decrypt(data) {
    return decodeURIComponent(atob(data));
  },
  
  // Initialize default users
  initializeDefaultUsers() {
    if (this.database.users.length === 0) {
      const defaultUsers = [
        {
          id: 1,
          name: 'Rachael Richards',
          email: 'mrselectrictucson@gmail.com',
          username: 'rrichards',
          employeeId: 'EMP001',
          password: this.hashPassword('SecurePass123!'),
          department: 'management',
          position: 'CEO',
          isManager: true,
          isSalaried: true,
          hourlyRate: 0,
          overtimeRate: 0,
          phone: '(520) 555-0001',
          createdAt: new Date().toISOString()
        },
        {
          id: 2,
          name: 'Brad Richards',
          email: 'mr.electric.tucson@gmail.com',
          username: 'brichards',
          employeeId: 'EMP002',
          password: this.hashPassword('SecurePass123!'),
          department: 'management',
          position: 'President',
          isManager: true,
          isSalaried: true,
          hourlyRate: 0,
          overtimeRate: 0,
          phone: '(520) 555-0002',
          createdAt: new Date().toISOString()
        },
        {
          id: 3,
          name: 'Cherish Richards',
          email: 'mrelectriccherish@gmail.com',
          username: 'crichards',
          employeeId: 'EMP003',
          password: this.hashPassword('SecurePass123!'),
          department: 'management',
          position: 'Office Manager',
          isManager: true,
          isSalaried: false,
          hourlyRate: 23.55,
          overtimeRate: 35.33,
          phone: '(520) 555-0003',
          createdAt: new Date().toISOString()
        },
        {
          id: 4,
          name: 'Logan Richards',
          email: 'tucson@mrelectric.com',
          username: 'lrichards',
          employeeId: 'EMP004',
          password: this.hashPassword('SecurePass123!'),
          department: 'management',
          position: 'Operations Manager',
          isManager: true,
          isAdmin: true,
          isSalaried: false,
          hourlyRate: 28.55,
          overtimeRate: 42.83,
          phone: '(520) 555-0004',
          createdAt: new Date().toISOString()
        },
        {
          id: 5,
          name: 'Anastosia Piggue',
          email: 'mrelectricoffice2@gmail.com',
          username: 'apiggue',
          employeeId: 'EMP005',
          password: this.hashPassword('SecurePass123!'),
          department: 'admin',
          position: 'Administrative Assistant',
          isManager: false,
          isSalaried: false,
          hourlyRate: 17.50,
          overtimeRate: 26.25,
          phone: '(520) 555-0005',
          createdAt: new Date().toISOString()
        },
        {
          id: 6,
          name: 'Bryce Tucker',
          email: 'mrelectricoffice3@gmail.com',
          username: 'btucker',
          employeeId: 'EMP006',
          password: this.hashPassword('SecurePass123!'),
          department: 'field',
          position: 'Electrician',
          isManager: false,
          isSalaried: false,
          hourlyRate: 17.35,
          overtimeRate: 26.03,
          phone: '(520) 555-0006',
          createdAt: new Date().toISOString()
        },
        {
          id: 7,
          name: 'Ben Tucker',
          email: 'mrelectricoffice4@gmail.com',
          username: 'bentucker',
          employeeId: 'EMP007',
          password: this.hashPassword('SecurePass123!'),
          department: 'field',
          position: 'Apprentice Electrician',
          isManager: false,
          isSalaried: false,
          hourlyRate: 17.00,
          overtimeRate: 25.50,
          phone: '(520) 555-0007',
          createdAt: new Date().toISOString()
        }
      ];
      
      this.database.users = defaultUsers;
      this.saveDatabase();
    }
  },
  
  // Initialize pay periods
  initializePayPeriods() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const startOfYear = new Date(currentYear, 0, 1);
    
    // Find first Sunday
    let firstSunday = new Date(startOfYear);
    while (firstSunday.getDay() !== 0) {
      firstSunday.setDate(firstSunday.getDate() + 1);
    }
    
    // Generate bi-weekly periods
    this.payPeriods = [];
    let periodStart = new Date(firstSunday);
    let periodNumber = 1;
    
    while (periodStart.getFullYear() === currentYear) {
      const periodEnd = new Date(periodStart);
      periodEnd.setDate(periodEnd.getDate() + 13); // 2 weeks - 1 day
      
      this.payPeriods.push({
        id: `${currentYear}-P${periodNumber.toString().padStart(2, '0')}`,
        number: periodNumber,
        startDate: new Date(periodStart),
        endDate: new Date(periodEnd),
        year: currentYear
      });
      
      periodStart.setDate(periodStart.getDate() + 14);
      periodNumber++;
    }
  },
  
  // Hash password
  hashPassword(password) {
    // Simple hash for demo - use bcrypt in production
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
      const char = password.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return Math.abs(hash).toString(16);
  },
  
  // Check existing session
  checkSession() {
    const session = sessionStorage.getItem('mreSession');
    if (session) {
      const data = JSON.parse(session);
      if (data.expiry > Date.now()) {
        this.currentUser = data.user;
        this.showApp();
      }
    }
  },
  
  // Setup event listeners
  setupEventListeners() {
    // Auto-save on input
    document.addEventListener('input', (e) => {
      if (e.target.closest('.timesheet-table') && this.settings.autoSave) {
        this.autoSave();
      }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey) {
        switch(e.key) {
          case 's':
            e.preventDefault();
            this.saveCurrentTimesheet();
            break;
          case 'e':
            e.preventDefault();
            this.exportCurrentTimesheet();
            break;
          case '/':
            e.preventDefault();
            this.showKeyboardShortcuts();
            break;
        }
      }
      
      if (e.key === 'Escape') {
        this.closeModal();
        if (document.getElementById('sidebar').classList.contains('active')) {
          toggleSidebar();
        }
      }
    });
    
    // Settings checkboxes
    document.getElementById('soundEnabled').addEventListener('change', (e) => {
      this.settings.soundEnabled = e.target.checked;
    });
    
    document.getElementById('autoSaveEnabled').addEventListener('change', (e) => {
      this.settings.autoSave = e.target.checked;
    });
    
    document.getElementById('compactView').addEventListener('change', (e) => {
      this.settings.compactView = e.target.checked;
      document.body.classList.toggle('compact-view', e.target.checked);
    });
  },
  
  // Show app after login
  showApp() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('appContainer').classList.add('active');
    
    // Update user info
    document.getElementById('userName').textContent = this.currentUser.name;
    document.getElementById('userRole').textContent = this.currentUser.position;
    document.getElementById('userAvatar').textContent = this.currentUser.name.charAt(0);
    
    // Show manager/admin tabs
    if (this.currentUser.isManager) {
      document.getElementById('allVaultsTab').style.display = 'block';
      document.getElementById('allArchivesTab').style.display = 'block';
    }
    
    if (this.currentUser.isAdmin) {
      document.getElementById('adminTab').style.display = 'block';
    }
    
    // Load data
    this.loadCurrentTimesheets();
    this.updateStats();
    this.checkAchievements();
    this.processVaultAndArchive();
    
    // Start auto-save
    if (this.settings.autoSave) {
      setInterval(() => this.autoSave(), 30000);
    }
    
    // Check for auto-export
    setInterval(() => this.checkAutoExport(), 60000);
  },
  
  // Load current timesheets
  loadCurrentTimesheets() {
    const now = new Date();
    const currentPeriods = this.payPeriods.filter(p => 
      p.endDate >= now && p.startDate <= new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000)
    ).slice(0, 2);
    
    const container = document.getElementById('currentTimesheets');
    container.innerHTML = '';
    
    currentPeriods.forEach((period, index) => {
      const timesheet = this.getOrCreateTimesheet(period.id);
      container.appendChild(this.createTimesheetCard(timesheet, period, index === 0));
    });
  },
  
  // Get or create timesheet
  getOrCreateTimesheet(periodId) {
    let timesheet = this.database.timesheets.find(t => 
      t.userId === this.currentUser.id && t.periodId === periodId
    );
    
    if (!timesheet) {
      const period = this.payPeriods.find(p => p.id === periodId);
      timesheet = {
        id: `${this.currentUser.id}_${periodId}`,
        userId: this.currentUser.id,
        periodId: periodId,
        entries: this.createEmptyEntries(period),
        status: 'active',
        createdAt: new Date().toISOString(),
        lastModified: new Date().toISOString()
      };
      
      this.database.timesheets.push(timesheet);
      this.saveDatabase();
    }
    
    return timesheet;
  },
  
  // Create empty entries for a period
  createEmptyEntries(period) {
    const entries = [];
    const current = new Date(period.startDate);
    
    while (current <= period.endDate) {
      entries.push({
        date: new Date(current).toISOString(),
        dayOfWeek: current.getDay(),
        workType: 'regular',
        regularHours: 0,
        overtimeHours: 0,
        timeOffType: '',
        timeOffHours: 0,
        notes: ''
      });
      
      current.setDate(current.getDate() + 1);
    }
    
    return entries;
  },
  
  // Create timesheet card
  createTimesheetCard(timesheet, period, isCurrent) {
    const card = document.createElement('div');
    card.className = 'timesheet-card';
    
    const periodDates = `${this.formatDate(period.startDate)} - ${this.formatDate(period.endDate)}`;
    
    card.innerHTML = `
      <div class="timesheet-header">
        <div>
          <h3 class="timesheet-title">Pay Period ${period.number} - ${isCurrent ? 'Current' : 'Next'}</h3>
          <p style="color: var(--gray); font-size: 14px;">${periodDates}</p>
        </div>
        <div style="text-align: right;">
          <p style="font-weight: 600;">
            ${this.currentUser.isSalaried ? 'Salaried' : 
              `${this.currentUser.hourlyRate.toFixed(2)}/hr | OT: ${this.currentUser.overtimeRate.toFixed(2)}/hr`}
          </p>
        </div>
      </div>
      <div class="timesheet-body">
        ${this.createTimesheetTable(timesheet, period)}
        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
          <button class="btn btn-primary" onclick="MRESystem.saveTimesheet('${timesheet.id}')">
            üíæ Save Changes
          </button>
          <button class="btn btn-success" onclick="MRESystem.exportTimesheet('${timesheet.id}')">
            üì• Export to ADP
          </button>
          <button class="btn btn-primary" onclick="MRESystem.emailTimesheet('${timesheet.id}')">
            üìß Email Timesheet
          </button>
          <button class="btn btn-secondary" onclick="MRESystem.printTimesheet('${timesheet.id}')">
            üñ®Ô∏è Print
          </button>
        </div>
      </div>
    `;
    
    return card;
  },
  
  // Create timesheet table
  createTimesheetTable(timesheet, period) {
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    let html = `
      <table class="timesheet-table">
        <thead>
          <tr>
            <th>Day</th>
            <th>Date</th>
            <th>Work Type</th>
            <th>Regular Hours</th>
            <th>Overtime Hours</th>
            <th>Daily Total</th>
            <th>Daily Earnings</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    let weekNum = 1;
    let weekRegular = 0;
    let weekOvertime = 0;
    let totalRegular = 0;
    let totalOvertime = 0;
    let totalEarnings = 0;
    
    timesheet.entries.forEach((entry, index) => {
      const date = new Date(entry.date);
      const dayName = days[entry.dayOfWeek];
      
      // Week separator
      if (index === 7) {
        html += `<tr class="week-separator"><td colspan="8"></td></tr>`;
        weekNum = 2;
        weekRegular = 0;
        weekOvertime = 0;
      }
      
      const isTimeOff = entry.timeOffType !== '';
      const dailyTotal = isTimeOff ? entry.timeOffHours : 
        (entry.regularHours + entry.overtimeHours);
      const dailyEarnings = isTimeOff ? 0 : 
        (entry.regularHours * this.currentUser.hourlyRate + 
         entry.overtimeHours * this.currentUser.overtimeRate);
      
      totalRegular += entry.regularHours;
      totalOvertime += entry.overtimeHours;
      totalEarnings += dailyEarnings;
      weekRegular += entry.regularHours;
      weekOvertime += entry.overtimeHours;
      
      const rowClass = isTimeOff ? `time-off-${entry.timeOffType}` : '';
      
      html += `
        <tr class="${rowClass}" data-index="${index}">
          <td><strong>${dayName}</strong></td>
          <td>${date.getMonth() + 1}/${date.getDate()}</td>
          <td>
            <select class="form-control" onchange="MRESystem.updateWorkType('${timesheet.id}', ${index}, this.value)">
              <option value="regular" ${entry.workType === 'regular' ? 'selected' : ''}>Work Day</option>
              <option value="sick" ${entry.timeOffType === 'sick' ? 'selected' : ''}>Sick</option>
              <option value="vacation" ${entry.timeOffType === 'vacation' ? 'selected' : ''}>Vacation</option>
              <option value="unpaid" ${entry.timeOffType === 'unpaid' ? 'selected' : ''}>Unpaid</option>
            </select>
          </td>
      `;
      
      if (isTimeOff) {
        html += `
          <td colspan="2">
            <select class="form-control" style="width: 100%;" 
              onchange="MRESystem.updateTimeOffHours('${timesheet.id}', ${index}, this.value)">
              ${this.generateTimeOffOptions(entry.timeOffHours)}
            </select>
          </td>
        `;
      } else {
        html += `
          <td>
            <input type="number" step="0.01" min="0" max="24" 
              value="${entry.regularHours.toFixed(2)}"
              onchange="MRESystem.updateHours('${timesheet.id}', ${index}, 'regular', this.value)">
          </td>
          <td>
            <input type="number" step="0.01" min="0" max="24" 
              value="${entry.overtimeHours.toFixed(2)}"
              onchange="MRESystem.updateHours('${timesheet.id}', ${index}, 'overtime', this.value)">
          </td>
        `;
      }
      
      html += `
          <td style="font-weight: 600;">${dailyTotal.toFixed(2)}</td>
          <td style="color: ${isTimeOff ? 'var(--info)' : 'var(--success)'}; font-weight: 600;">
            ${isTimeOff ? entry.timeOffType.charAt(0).toUpperCase() + entry.timeOffType.slice(1) : 
              ' + dailyEarnings.toFixed(2)}
          </td>
          <td>
            <input type="text" value="${entry.notes}" 
              onchange="MRESystem.updateNotes('${timesheet.id}', ${index}, this.value)">
          </td>
        </tr>
      `;
    });
    
    // Period totals
    const periodTotal = totalRegular + totalOvertime;
    html += `
        </tbody>
        <tfoot>
          <tr class="table-total">
            <td colspan="3"><strong>PERIOD TOTALS</strong></td>
            <td><strong>${totalRegular.toFixed(2)}</strong></td>
            <td><strong>${totalOvertime.toFixed(2)}</strong></td>
            <td><strong>${periodTotal.toFixed(2)}</strong></td>
            <td style="color: var(--success);"><strong>${totalEarnings.toFixed(2)}</strong></td>
            <td></td>
          </tr>
    `;
    
    // Overtime warning
    if (periodTotal > 80) {
      html += `
          <tr style="background: #fef3c7;">
            <td colspan="8" style="text-align: center; color: var(--warning); font-weight: 600;">
              ‚ö†Ô∏è Warning: ${periodTotal.toFixed(2)} hours exceeds 80-hour bi-weekly threshold
            </td>
          </tr>
      `;
    }
    
    html += `
        </tfoot>
      </table>
    `;
    
    return html;
  },
  
  // Generate time off options
  generateTimeOffOptions(selected) {
    let options = '<option value="0">Select hours...</option>';
    for (let i = 0.5; i <= 8; i += 0.5) {
      options += `<option value="${i}" ${i === selected ? 'selected' : ''}>${i} hours</option>`;
    }
    return options;
  },
  
  // Update work type
  updateWorkType(timesheetId, index, value) {
    const timesheet = this.database.timesheets.find(t => t.id === timesheetId);
    if (!timesheet) return;
    
    const entry = timesheet.entries[index];
    
    if (value === 'regular') {
      entry.workType = 'regular';
      entry.timeOffType = '';
      entry.timeOffHours = 0;
    } else {
      entry.workType = 'timeoff';
      entry.timeOffType = value;
      entry.timeOffHours = 8; // Default to 8 hours
      entry.regularHours = 0;
      entry.overtimeHours = 0;
    }
    
    timesheet.lastModified = new Date().toISOString();
    this.saveDatabase();
    this.loadCurrentTimesheets();
    this.updateStats();
  },
  
  // Update hours
  updateHours(timesheetId, index, type, value) {
    const timesheet = this.database.timesheets.find(t => t.id === timesheetId);
    if (!timesheet) return;
    
    const entry = timesheet.entries[index];
    const hours = parseFloat(value) || 0;
    
    if (type === 'regular') {
      entry.regularHours = Math.min(24, Math.max(0, hours));
    } else {
      entry.overtimeHours = Math.min(24, Math.max(0, hours));
    }
    
    // Verify against Phoenix time
    const entryDate = new Date(entry.date);
    const phoenixTime = this.getPhoenixTime();
    
    if (entryDate > phoenixTime) {
      this.showToast('Cannot enter hours for future dates', 'error');
      if (type === 'regular') {
        entry.regularHours = 0;
      } else {
        entry.overtimeHours = 0;
      }
    }
    
    timesheet.lastModified = new Date().toISOString();
    this.saveDatabase();
    this.updateStats();
  },
  
  // Update time off hours
  updateTimeOffHours(timesheetId, index, value) {
    const timesheet = this.database.timesheets.find(t => t.id === timesheetId);
    if (!timesheet) return;
    
    const entry = timesheet.entries[index];
    entry.timeOffHours = parseFloat(value) || 0;
    
    timesheet.lastModified = new Date().toISOString();
    this.saveDatabase();
    this.updateStats();
  },
  
  // Update notes
  updateNotes(timesheetId, index, value) {
    const timesheet = this.database.timesheets.find(t => t.id === timesheetId);
    if (!timesheet) return;
    
    timesheet.entries[index].notes = value;
    timesheet.lastModified = new Date().toISOString();
    this.saveDatabase();
  },
  
  // Get Phoenix time
  getPhoenixTime() {
    const now = new Date();
    const phoenixOffset = -7 * 60; // MST offset in minutes
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    return new Date(utc + (phoenixOffset * 60000));
  },
  
  // Format date
  formatDate(date) {
    return new Intl.DateTimeFormat('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    }).format(date);
  },
  
  // Save timesheet
  saveTimesheet(timesheetId) {
    const timesheet = this.database.timesheets.find(t => t.id === timesheetId);
    if (!timesheet) return;
    
    timesheet.lastModified = new Date().toISOString();
    this.saveDatabase();
    
    this.showToast('Timesheet saved successfully!', 'success');
    this.checkAchievements();
  },
  
  // Export timesheet to ADP format
  exportTimesheet(timesheetId) {
    const timesheet = this.database.timesheets.find(t => t.id === timesheetId);
    if (!timesheet) return;
    
    const period = this.payPeriods.find(p => p.id === timesheet.periodId);
    const user = this.currentUser;
    
    // Generate ADP CSV
    let csv = '# ADP WorkforceNow Time Import Format\n';
    csv += '# Generated by MRE Electric Timesheet System\n';
    csv += 'Company Code,File Number,Pay Code,Hours,Rate,Amount,Date\n';
    
    timesheet.entries.forEach(entry => {
      const date = new Date(entry.date);
      const dateStr = `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}/${date.getFullYear()}`;
      
      if (entry.regularHours > 0) {
        csv += `MRE,${user.employeeId},REG,${entry.regularHours.toFixed(2)},${user.hourlyRate.toFixed(2)},${(entry.regularHours * user.hourlyRate).toFixed(2)},${dateStr}\n`;
      }
      
      if (entry.overtimeHours > 0) {
        csv += `MRE,${user.employeeId},OT,${entry.overtimeHours.toFixed(2)},${user.overtimeRate.toFixed(2)},${(entry.overtimeHours * user.overtimeRate).toFixed(2)},${dateStr}\n`;
      }
    });
    
    // Download file
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ADP_Hours_${user.name.replace(/\s+/g, '_')}_${period.id}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    this.showToast('ADP file exported successfully!', 'success');
    this.logAudit('export', `Exported timesheet ${timesheetId}`);
  },
  
  // Email timesheet
  emailTimesheet(timesheetId) {
    const timesheet = this.database.timesheets.find(t => t.id === timesheetId);
    if (!timesheet) return;
    
    // In real implementation, this would send an email
    this.showToast('Timesheet emailed to tucson@mrelectric.com', 'success');
    this.logAudit('email', `Emailed timesheet ${timesheetId}`);
  },
  
  // Print timesheet
  printTimesheet(timesheetId) {
    window.print();
  },
  
  // Auto-save
  autoSave() {
    const indicator = document.getElementById('autoSaveIndicator');
    indicator.classList.add('saving');
    
    this.saveDatabase();
    
    setTimeout(() => {
      indicator.classList.remove('saving');
    }, 1000);
  },
  
  // Update stats
  updateStats() {
    const now = new Date();
    const currentPeriod = this.payPeriods.find(p => 
      p.startDate <= now && p.endDate >= now
    );
    
    if (currentPeriod) {
      const timesheet = this.database.timesheets.find(t => 
        t.userId === this.currentUser.id && t.periodId === currentPeriod.id
      );
      
      if (timesheet) {
        let totalHours = 0;
        let todayHours = 0;
        let weekHours = 0;
        
        timesheet.entries.forEach(entry => {
          const entryDate = new Date(entry.date);
          const hours = entry.timeOffHours || (entry.regularHours + entry.overtimeHours);
          
          totalHours += hours;
          
          if (entryDate.toDateString() === now.toDateString()) {
            todayHours = hours;
          }
          
          // Calculate week hours
          const weekStart = new Date(now);
          weekStart.setDate(weekStart.getDate() - weekStart.getDay());
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          
          if (entryDate >= weekStart && entryDate <= weekEnd) {
            weekHours += hours;
          }
        });
        
        // Update UI
        document.getElementById('periodHours').textContent = totalHours.toFixed(2);
        document.getElementById('productivityScore').textContent = 
          Math.min(100, Math.round((totalHours / 80) * 100)) + '%';
        document.getElementById('dailyHours').textContent = todayHours.toFixed(1);
        document.getElementById('weeklyHours').textContent = weekHours.toFixed(1);
        
        // Update progress bars
        document.getElementById('dailyProgress').style.width = 
          Math.min(100, (todayHours / 8) * 100) + '%';
        document.getElementById('weeklyProgress').style.width = 
          Math.min(100, (weekHours / 40) * 100) + '%';
      }
    }
    
    // Update streak
    this.updateStreak();
  },
  
  // Update streak
  updateStreak() {
    let streak = 0;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Count backwards from today
    for (let i = 0; i < 365; i++) {
      const checkDate = new Date(today);
      checkDate.setDate(checkDate.getDate() - i);
      
      // Skip weekends
      if (checkDate.getDay() === 0 || checkDate.getDay() === 6) continue;
      
      // Check if user logged time on this date
      let foundEntry = false;
      
      for (const timesheet of this.database.timesheets) {
        if (timesheet.userId !== this.currentUser.id) continue;
        
        const entry = timesheet.entries.find(e => {
          const entryDate = new Date(e.date);
          entryDate.setHours(0, 0, 0, 0);
          return entryDate.getTime() === checkDate.getTime() && 
            (e.regularHours > 0 || e.overtimeHours > 0 || e.timeOffHours > 0);
        });
        
        if (entry) {
          foundEntry = true;
          break;
        }
      }
      
      if (foundEntry) {
        streak++;
      } else if (i > 0) {
        // Don't break on today if no entry yet
        break;
      }
    }
    
    document.getElementById('dayStreak').textContent = streak;
  },
  
  // Check achievements
  checkAchievements() {
    const achievements = [];
    
    // First Timer - First timesheet completed
    const hasTimesheet = this.database.timesheets.some(t => 
      t.userId === this.currentUser.id && 
      t.entries.some(e => e.regularHours > 0 || e.overtimeHours > 0)
    );
    
    if (hasTimesheet && !this.hasAchievement('first-timer')) {
      achievements.push({
        id: 'first-timer',
        icon: 'üèÜ',
        title: 'First Timer',
        description: 'Completed your first timesheet!'
      });
    }
    
    // Week Warrior - 7 day streak
    const streak = parseInt(document.getElementById('dayStreak').textContent);
    if (streak >= 7 && !this.hasAchievement('week-warrior')) {
      achievements.push({
        id: 'week-warrior',
        icon: 'üî•',
        title: 'Week Warrior',
        description: '7-day streak achieved!'
      });
    }
    
    // Century Club - 100+ hours in a period
    const periodHours = parseFloat(document.getElementById('periodHours').textContent);
    if (periodHours >= 100 && !this.hasAchievement('century-club')) {
      achievements.push({
        id: 'century-club',
        icon: 'üíØ',
        title: 'Century Club',
        description: '100+ hours in one period!'
      });
    }
    
    // Consistent Tracker - 10 timesheets
    const completedTimesheets = this.database.timesheets.filter(t => 
      t.userId === this.currentUser.id && 
      t.entries.some(e => e.regularHours > 0 || e.overtimeHours > 0)
    ).length;
    
    if (completedTimesheets >= 10 && !this.hasAchievement('consistent-tracker')) {
      achievements.push({
        id: 'consistent-tracker',
        icon: 'üìä',
        title: 'Consistent Tracker',
        description: '10 timesheets completed!'
      });
    }
    
    // Grant achievements
    achievements.forEach(achievement => {
      this.grantAchievement(achievement);
    });
    
    // Update achievements list
    this.updateAchievementsList();
  },
  
  // Has achievement
  hasAchievement(achievementId) {
    return this.database.achievements.some(a => 
      a.userId === this.currentUser.id && a.achievementId === achievementId
    );
  },
  
  // Grant achievement
  grantAchievement(achievement) {
    this.database.achievements.push({
      userId: this.currentUser.id,
      achievementId: achievement.id,
      grantedAt: new Date().toISOString()
    });
    
    this.saveDatabase();
    
    // Show notification
    this.showAchievementNotification(achievement);
  },
  
  // Show achievement notification
  showAchievementNotification(achievement) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const toastIcon = document.getElementById('toastIcon');
    
    toastIcon.textContent = achievement.icon;
    toastMessage.innerHTML = `<strong>Achievement Unlocked!</strong><br>${achievement.title}`;
    toast.className = 'toast success';
    toast.classList.add('show');
    
    if (this.settings.soundEnabled) {
      // Play achievement sound
      this.playSound('achievement');
    }
    
    setTimeout(() => {
      toast.classList.remove('show');
    }, 5000);
  },
  
  // Update achievements list
  updateAchievementsList() {
    const container = document.getElementById('achievementsList');
    const userAchievements = this.database.achievements.filter(a => 
      a.userId === this.currentUser.id
    );
    
    if (userAchievements.length === 0) {
      container.innerHTML = '<p style="color: var(--gray); font-size: 14px;">No achievements yet!</p>';
      return;
    }
    
    const achievementData = {
      'first-timer': { icon: 'üèÜ', title: 'First Timer', description: 'Completed your first timesheet!' },
      'week-warrior': { icon: 'üî•', title: 'Week Warrior', description: '7-day streak achieved!' },
      'century-club': { icon: 'üíØ', title: 'Century Club', description: '100+ hours in one period!' },
      'consistent-tracker': { icon: 'üìä', title: 'Consistent Tracker', description: '10 timesheets completed!' }
    };
    
    container.innerHTML = userAchievements.slice(-3).reverse().map(a => {
      const data = achievementData[a.achievementId];
      return `
        <div class="achievement">
          <div class="achievement-icon">${data.icon}</div>
          <div class="achievement-info">
            <h4>${data.title}</h4>
            <p>${data.description}</p>
          </div>
        </div>
      `;
    }).join('');
  },
  
  // Process vault and archive
  processVaultAndArchive() {
    const now = new Date();
    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    const threeWeeksAgo = new Date(now.getTime() - 21 * 24 * 60 * 60 * 1000);
    
    this.database.timesheets.forEach(timesheet => {
      const period = this.payPeriods.find(p => p.id === timesheet.periodId);
      if (!period) return;
      
      if (period.endDate < threeWeeksAgo) {
        timesheet.status = 'archived';
      } else if (period.endDate < oneWeekAgo) {
        // Auto-export if not already done
        if (timesheet.status === 'active') {
          this.autoExportTimesheet(timesheet.id);
        }
        timesheet.status = 'vault';
      }
    });
    
    this.saveDatabase();
  },
  
  // Auto-export timesheet
  autoExportTimesheet(timesheetId) {
    this.exportTimesheet(timesheetId);
    this.emailTimesheet(timesheetId);
    
    this.logAudit('auto-export', `Auto-exported timesheet ${timesheetId} to vault`);
  },
  
  // Check for auto-export
  checkAutoExport() {
    this.processVaultAndArchive();
  },
  
  // Fill standard period
  fillStandardPeriod() {
    const now = new Date();
    const currentPeriod = this.payPeriods.find(p => 
      p.startDate <= now && p.endDate >= now
    );
    
    if (!currentPeriod) return;
    
    const timesheet = this.getOrCreateTimesheet(currentPeriod.id);
    
    timesheet.entries.forEach(entry => {
      const date = new Date(entry.date);
      const dayOfWeek = date.getDay();
      
      // Skip weekends
      if (dayOfWeek === 0 || dayOfWeek === 6) return;
      
      // Only fill if empty
      if (entry.regularHours === 0 && entry.overtimeHours === 0 && !entry.timeOffType) {
        entry.regularHours = 8;
      }
    });
    
    timesheet.lastModified = new Date().toISOString();
    this.saveDatabase();
    this.loadCurrentTimesheets();
    this.updateStats();
    
    this.showToast('Standard 8-hour days filled for weekdays', 'success');
  },
  
  // Copy previous period
  copyPreviousPeriod() {
    const now = new Date();
    const currentPeriod = this.payPeriods.find(p => 
      p.startDate <= now && p.endDate >= now
    );
    
    if (!currentPeriod) return;
    
    // Find previous period
    const currentIndex = this.payPeriods.findIndex(p => p.id === currentPeriod.id);
    if (currentIndex <= 0) {
      this.showToast('No previous period found', 'error');
      return;
    }
    
    const previousPeriod = this.payPeriods[currentIndex - 1];
    const previousTimesheet = this.database.timesheets.find(t => 
      t.userId === this.currentUser.id && t.periodId === previousPeriod.id
    );
    
    if (!previousTimesheet) {
      this.showToast('No previous timesheet found', 'error');
      return;
    }
    
    const currentTimesheet = this.getOrCreateTimesheet(currentPeriod.id);
    
    // Copy entries
    currentTimesheet.entries.forEach((entry, index) => {
      const prevEntry = previousTimesheet.entries[index];
      if (prevEntry) {
        entry.workType = prevEntry.workType;
        entry.regularHours = prevEntry.regularHours;
        entry.overtimeHours = prevEntry.overtimeHours;
        entry.timeOffType = prevEntry.timeOffType;
        entry.timeOffHours = prevEntry.timeOffHours;
      }
    });
    
    currentTimesheet.lastModified = new Date().toISOString();
    this.saveDatabase();
    this.loadCurrentTimesheets();
    this.updateStats();
    
    this.showToast('Previous period copied successfully', 'success');
  },
  
  // Set work schedule
  setWorkSchedule() {
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    
    modalTitle.textContent = 'Set Work Schedule';
    modalBody.innerHTML = `
      <p>Set your regular work schedule to auto-fill future timesheets.</p>
      <form id="workScheduleForm">
        <div class="form-group">
          <label class="form-label">Monday - Friday</label>
          <input type="number" class="form-control" id="weekdayHours" 
                 step="0.5" min="0" max="24" value="8" required>
        </div>
        <div class="form-group">
          <label class="form-label">Saturday</label>
          <input type="number" class="form-control" id="saturdayHours" 
                 step="0.5" min="0" max="24" value="0">
        </div>
        <div class="form-group">
          <label class="form-label">Sunday</label>
          <input type="number" class="form-control" id="sundayHours" 
                 step="0.5" min="0" max="24" value="0">
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="MRESystem.closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Schedule</button>
        </div>
      </form>
    `;
    
    modal.classList.add('active');
    
    document.getElementById('workScheduleForm').onsubmit = (e) => {
      e.preventDefault();
      this.showToast('Work schedule saved', 'success');
      this.closeModal();
    };
  },
  
  // Clear current period
  clearCurrentPeriod() {
    if (!confirm('Are you sure you want to clear all entries for the current period?')) return;
    
    const now = new Date();
    const currentPeriod = this.payPeriods.find(p => 
      p.startDate <= now && p.endDate >= now
    );
    
    if (!currentPeriod) return;
    
    const timesheet = this.database.timesheets.find(t => 
      t.userId === this.currentUser.id && t.periodId === currentPeriod.id
    );
    
    if (!timesheet) return;
    
    timesheet.entries = this.createEmptyEntries(currentPeriod);
    timesheet.lastModified = new Date().toISOString();
    
    this.saveDatabase();
    this.loadCurrentTimesheets();
    this.updateStats();
    
    this.showToast('Current period cleared', 'success');
  },
  
  // Show toast
  showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const toastIcon = document.getElementById('toastIcon');
    
    const icons = {
      success: '‚úÖ',
      error: '‚ùå',
      warning: '‚ö†Ô∏è',
      info: '‚ÑπÔ∏è'
    };
    
    toastIcon.textContent = icons[type];
    toastMessage.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');
    
    if (this.settings.soundEnabled) {
      this.playSound(type);
    }
    
    setTimeout(() => {
      toast.classList.remove('show');
    }, 3000);
  },
  
  // Play sound
  playSound(type) {
    // In a real implementation, this would play actual sounds
    console.log('Playing sound:', type);
  },
  
  // Close modal
  closeModal() {
    document.getElementById('modal').classList.remove('active');
  },
  
  // Show keyboard shortcuts
  showKeyboardShortcuts() {
    alert(`Keyboard Shortcuts:
    
Ctrl+S - Save current timesheet
Ctrl+E - Export to ADP
Ctrl+/ - Show this help
Esc - Close dialogs`);
  },
  
  // Log audit
  logAudit(action, details) {
    this.database.audit.push({
      userId: this.currentUser.id,
      action: action,
      details: details,
      timestamp: new Date().toISOString()
    });
    
    this.saveDatabase();
  },
  
  // Generate username from name
  generateUsername(fullName) {
    const parts = fullName.toLowerCase().split(' ');
    if (parts.length >= 2) {
      return parts[0].charAt(0) + parts[parts.length - 1];
    }
    return parts[0];
  },
  
  // Generate temporary password
  generateTempPassword() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#;
    let password = '';
    for (let i = 0; i < 12; i++) {
      password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
  },
  
  // Generate 2FA code
  generate2FACode() {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }
};

// UI Functions
function showAuthTab(tab) {
  document.querySelectorAll('.auth-form').forEach(form => {
    form.style.display = 'none';
    form.classList.remove('active');
  });
  
  document.querySelectorAll('.auth-tabs button').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (tab === 'login') {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('loginForm').classList.add('active');
    document.querySelector('.auth-tabs button:nth-child(1)').classList.add('active');
  } else {
    document.getElementById('registerForm').style.display = 'block';
    document.getElementById('registerForm').classList.add('active');
    document.querySelector('.auth-tabs button:nth-child(2)').classList.add('active');
  }
}

// Toggle hourly rate field
function toggleHourlyRate() {
  const payType = document.getElementById('regPayType').value;
  const hourlyGroup = document.getElementById('hourlyRateGroup');
  
  if (payType === 'hourly') {
    hourlyGroup.style.display = 'block';
    document.getElementById('regHourlyRate').required = true;
  } else {
    hourlyGroup.style.display = 'none';
    document.getElementById('regHourlyRate').required = false;
  }
}

// Handle login
async function handleLogin(event) {
  event.preventDefault();
  
  const username = document.getElementById('loginUsername').value.toLowerCase();
  const password = document.getElementById('loginPassword').value;
  
  // Find user by username or email
  const user = MRESystem.database.users.find(u => 
    u.username === username || u.email.toLowerCase() === username
  );
  
  if (!user) {
    document.getElementById('loginError').textContent = 'Invalid username or password';
    document.getElementById('loginError').classList.add('show');
    return;
  }
  
  // Check password
  if (user.password !== MRESystem.hashPassword(password)) {
    document.getElementById('loginError').textContent = 'Invalid username or password';
    document.getElementById('loginError').classList.add('show');
    return;
  }
  
  // Check for 2FA requirement
  const trustedDevice = localStorage.getItem('mre2FADevice');
  if (!trustedDevice || JSON.parse(trustedDevice).userId !== user.id) {
    // Show 2FA form
    show2FAForm(user);
  } else {
    // Login successful
    loginUser(user);
  }
}

// Show 2FA form
function show2FAForm(user) {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('twoFactorForm').classList.add('active');
  
  // Generate and "send" 2FA code
  const code = MRESystem.generate2FACode();
  sessionStorage.setItem('pending2FA', JSON.stringify({
    userId: user.id,
    code: code,
    expiry: Date.now() + 10 * 60 * 1000 // 10 minutes
  }));
  
  // In real implementation, this would send an email
  console.log('2FA Code:', code);
  MRESystem.showToast(`2FA code sent to ${user.email}`, 'info');
}

// Handle 2FA
async function handleTwoFactor(event) {
  event.preventDefault();
  
  const inputCode = document.getElementById('twoFactorCode').value;
  const rememberDevice = document.getElementById('rememberDevice').checked;
  
  const pending = JSON.parse(sessionStorage.getItem('pending2FA'));
  if (!pending || pending.expiry < Date.now()) {
    document.getElementById('twoFactorError').textContent = 'Code expired. Please login again.';
    document.getElementById('twoFactorError').classList.add('show');
    return;
  }
  
  if (inputCode !== pending.code) {
    document.getElementById('twoFactorError').textContent = 'Invalid code';
    document.getElementById('twoFactorError').classList.add('show');
    return;
  }
  
  // Find user
  const user = MRESystem.database.users.find(u => u.id === pending.userId);
  
  // Remember device if requested
  if (rememberDevice) {
    localStorage.setItem('mre2FADevice', JSON.stringify({
      userId: user.id,
      expiry: Date.now() + 30 * 24 * 60 * 60 * 1000 // 30 days
    }));
  }
  
  // Clear pending 2FA
  sessionStorage.removeItem('pending2FA');
  
  // Login user
  loginUser(user);
}

// Login user
function loginUser(user) {
  MRESystem.currentUser = user;
  
  // Create session
  sessionStorage.setItem('mreSession', JSON.stringify({
    user: user,
    token: Math.random().toString(36).substring(2),
    expiry: Date.now() + 60 * 60 * 1000 // 1 hour
  }));
  
  MRESystem.showToast(`Welcome back, ${user.name}!`, 'success');
  MRESystem.showApp();
}

// Resend 2FA code
function resendCode() {
  const pending = JSON.parse(sessionStorage.getItem('pending2FA'));
  if (!pending) return;
  
  const user = MRESystem.database.users.find(u => u.id === pending.userId);
  show2FAForm(user);
}

// Handle registration
async function handleRegister(event) {
  event.preventDefault();
  
  const formData = {
    fullName: document.getElementById('regFullName').value,
    email: document.getElementById('regEmail').value.toLowerCase(),
    phone: document.getElementById('regPhone').value,
    department: document.getElementById('regDepartment').value,
    position: document.getElementById('regPosition').value,
    payType: document.getElementById('regPayType').value,
    hourlyRate: parseFloat(document.getElementById('regHourlyRate').value) || 0
  };
  
  // Check if email exists
  if (MRESystem.database.users.some(u => u.email === formData.email)) {
    document.getElementById('registerError').textContent = 'Email already registered';
    document.getElementById('registerError').classList.add('show');
    return;
  }
  
  // Generate credentials
  const username = MRESystem.generateUsername(formData.fullName);
  const tempPassword = MRESystem.generateTempPassword();
  const employeeId = 'EMP' + (MRESystem.database.users.length + 1).toString().padStart(3, '0');
  
  // Create user
  const newUser = {
    id: Date.now(),
    name: formData.fullName,
    email: formData.email,
    username: username,
    employeeId: employeeId,
    password: MRESystem.hashPassword(tempPassword),
    department: formData.department,
    position: formData.position,
    isManager: false,
    isSalaried: formData.payType === 'salaried',
    hourlyRate: formData.payType === 'hourly' ? formData.hourlyRate : 0,
    overtimeRate: formData.payType === 'hourly' ? formData.hourlyRate * 1.5 : 0,
    phone: formData.phone,
    tempPassword: true,
    createdAt: new Date().toISOString()
  };
  
  MRESystem.database.users.push(newUser);
  MRESystem.saveDatabase();
  
  // Show success message with credentials
  const successHtml = `
    <div class="success-message">
      <span>‚úÖ</span>
      <div>
        <strong>Registration successful!</strong><br>
        Username: <strong>${username}</strong><br>
        Temporary Password: <strong>${tempPassword}</strong><br>
        <small>Please save these credentials. You'll be prompted to change your password on first login.</small>
      </div>
    </div>
  `;
  
  document.getElementById('registerForm').innerHTML = successHtml;
  
  // Email would be sent in real implementation
  console.log('Welcome email sent to:', formData.email);
  
  setTimeout(() => {
    showAuthTab('login');
    document.getElementById('loginUsername').value = username;
  }, 5000);
}

// Logout
function logout() {
  if (confirm('Are you sure you want to logout?')) {
    sessionStorage.removeItem('mreSession');
    location.reload();
  }
}

// Toggle dark mode
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  const icon = document.getElementById('darkModeIcon');
  icon.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
  MRESystem.settings.darkMode = document.body.classList.contains('dark-mode');
}

// Toggle sidebar
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.toggle('active');
  overlay.classList.toggle('active');
}

// Show tab
function showTab(tabName) {
  // Update breadcrumb
  const breadcrumbMap = {
    'current': 'Current Pay Periods',
    'viewer': 'View All Timesheets',
    'vault': 'My Vault',
    'archive': 'My Archive',
    'analytics': 'Analytics',
    'calendar': 'Calendar View',
    'allVaults': 'All Vaults',
    'allArchives': 'All Archives',
    'admin': 'Admin Panel'
  };
  
  document.getElementById('currentPage').textContent = breadcrumbMap[tabName];
  
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Remove active class from buttons
  document.querySelectorAll('.nav-tabs button').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Show selected tab
  document.getElementById(tabName).classList.add('active');
  
  // Set active button
  event.target.classList.add('active');
  
  // Load content for specific tabs
  switch(tabName) {
    case 'viewer':
      loadViewer();
      break;
    case 'vault':
      loadVault();
      break;
    case 'archive':
      loadArchive();
      break;
    case 'calendar':
      loadCalendar();
      break;
    case 'allVaults':
      loadAllVaults();
      break;
    case 'allArchives':
      loadAllArchives();
      break;
    case 'admin':
      loadAdminPanel();
      break;
  }
}

// Viewer functions
function loadViewer() {
  const content = document.getElementById('viewerContent');
  const timesheets = MRESystem.database.timesheets.filter(t => 
    t.userId === MRESystem.currentUser.id
  );
  
  if (timesheets.length === 0) {
    content.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìä</div>
        <h3>No timesheets found</h3>
      </div>
    `;
    return;
  }
  
  // Group by status
  const grouped = {
    active: timesheets.filter(t => t.status === 'active'),
    vault: timesheets.filter(t => t.status === 'vault'),
    archived: timesheets.filter(t => t.status === 'archived')
  };
  
  content.innerHTML = Object.entries(grouped).map(([status, sheets]) => {
    if (sheets.length === 0) return '';
    
    return `
      <h4 style="margin: 20px 0 10px; text-transform: capitalize;">${status} Timesheets</h4>
      ${sheets.map(timesheet => {
        const period = MRESystem.payPeriods.find(p => p.id === timesheet.periodId);
        return `
          <div style="padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px;">
            <strong>Period ${period.number}</strong> - 
            ${MRESystem.formatDate(period.startDate)} to ${MRESystem.formatDate(period.endDate)}
            <button class="btn btn-sm btn-primary" style="float: right;" 
              onclick="MRESystem.exportTimesheet('${timesheet.id}')">
              Export
            </button>
          </div>
        `;
      }).join('')}
    `;
  }).join('');
}

function filterViewer() {
  // Filter implementation
  loadViewer();
}

// Vault functions
function loadVault() {
  const content = document.getElementById('vaultContent');
  const vaultTimesheets = MRESystem.database.timesheets.filter(t => 
    t.userId === MRESystem.currentUser.id && t.status === 'vault'
  );
  
  if (vaultTimesheets.length === 0) {
    content.innerHTML = `
      <div class="timesheet-card">
        <div class="timesheet-body">
          <div class="empty-state">
            <div class="empty-state-icon">üóÑÔ∏è</div>
            <h3>No timesheets in vault</h3>
            <p>Completed timesheets will appear here after 1 week</p>
          </div>
        </div>
      </div>
    `;
    return;
  }
  
  content.innerHTML = vaultTimesheets.map(timesheet => {
    const period = MRESystem.payPeriods.find(p => p.id === timesheet.periodId);
    return MRESystem.createTimesheetCard(timesheet, period, false).outerHTML;
  }).join('');
}

// Archive functions
function loadArchive() {
  const content = document.getElementById('archiveContent');
  const archiveTimesheets = MRESystem.database.timesheets.filter(t => 
    t.userId === MRESystem.currentUser.id && t.status === 'archived'
  );
  
  if (archiveTimesheets.length === 0) {
    content.innerHTML = `
      <div class="timesheet-card">
        <div class="timesheet-body">
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <h3>No archived timesheets</h3>
            <p>Timesheets will be archived after 3 weeks</p>
          </div>
        </div>
      </div>
    `;
    return;
  }
  
  content.innerHTML = archiveTimesheets.map(timesheet => {
    const period = MRESystem.payPeriods.find(p => p.id === timesheet.periodId);
    return MRESystem.createTimesheetCard(timesheet, period, false).outerHTML;
  }).join('');
}

// Calendar functions
function loadCalendar() {
  const grid = document.getElementById('calendarGrid');
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  
  // Calendar headers
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  let html = days.map(day => `<div class="calendar-header">${day}</div>`).join('');
  
  // Get first day of month
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  // Empty cells before first day
  for (let i = 0; i < firstDay; i++) {
    html += '<div></div>';
  }
  
  // Days of month
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateStr = date.toISOString().split('T')[0];
    
    // Check if user has hours for this day
    let hasHours = false;
    let isTimeOff = false;
    
    for (const timesheet of MRESystem.database.timesheets) {
      if (timesheet.userId !== MRESystem.currentUser.id) continue;
      
      const entry = timesheet.entries.find(e => 
        e.date.split('T')[0] === dateStr
      );
      
      if (entry && (entry.regularHours > 0 || entry.overtimeHours > 0)) {
        hasHours = true;
        break;
      }
      
      if (entry && entry.timeOffHours > 0) {
        isTimeOff = true;
        break;
      }
    }
    
    const className = hasHours ? 'worked' : isTimeOff ? 'time-off' : '';
    
    html += `
      <div class="calendar-day ${className}">
        <div class="calendar-day-number">${day}</div>
        ${hasHours ? '<div class="calendar-day-hours">‚úì</div>' : ''}
        ${isTimeOff ? '<div class="calendar-day-hours">üèñÔ∏è</div>' : ''}
      </div>
    `;
  }
  
  grid.innerHTML = html;
}

// Manager functions
function loadAllVaults() {
  if (!MRESystem.currentUser.isManager) return;
  
  const content = document.getElementById('allVaultsContent');
  content.innerHTML = '<h3>Loading all employee vaults...</h3>';
  
  // Implementation for viewing all employee vaults
}

function loadAllArchives() {
  if (!MRESystem.currentUser.isManager) return;
  
  const content = document.getElementById('allArchivesContent');
  content.innerHTML = '<h3>Loading all employee archives...</h3>';
  
  // Implementation for viewing all employee archives
}

// Admin functions
function loadAdminPanel() {
  if (!MRESystem.currentUser.isAdmin) return;
  
  const userList = document.getElementById('userManagement');
  
  userList.innerHTML = `
    <table class="timesheet-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Department</th>
          <th>Position</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${MRESystem.database.users.map(user => `
          <tr>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.department}</td>
            <td>${user.position}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="editUser(${user.id})">Edit</button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function editUser(userId) {
  MRESystem.showToast('Edit user feature coming soon', 'info');
}

// Initialize system
MRESystem.init();
</script>

</body>
</html>